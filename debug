---
- name: Gather server data and generate cost report with Bash calculation
  hosts: all
  gather_facts: yes
  tasks:
    - name: Get local info for each server (Data Center)
      command: cat sample | grep {{ inventory_hostname }} | awk '{print $2}'
      register: local_info_command
      failed_when: false

    - name: Set local_info1 fact (with default DC1)
      set_fact:
        local_info1: "{{ local_info_command.stdout if local_info_command.stdout else 'DC1' }}"

    - name: Gather device details and store them for Bash processing
      copy:
        content: "{{ ansible_devices | to_json }}"
        dest: /tmp/devices_{{ inventory_hostname }}.json

    - name: Gather CPU, Memory, and GPU facts for processing in Bash
      copy:
        content: |
          CPU={{ ansible_processor_vcpus | int }}
          Memory={{ (ansible_memtotal_mb / 1024) | float | round(2) }}
        dest: /tmp/facts_{{ inventory_hostname }}.txt

    - name: Run Bash script to calculate accurate disk space and gather results
      shell: bash /tmp/calculate_resources.sh /tmp/devices_{{ inventory_hostname }}.json /tmp/facts_{{ inventory_hostname }}.txt
      register: bash_output

    - name: Parse Bash output
      set_fact:
        bash_results: "{{ bash_output.stdout | from_yaml }}"

    - name: Gather facts for the final CSV
      set_fact:
        total_cost: "{{ (bash_results.CPU * 24 * 30 * 0.05) + (bash_results.Memory * 24 * 30 * 0.01) + (bash_results.Disk_Space * 0.05) | round(2) }}"

    - name: Create CSV report using Jinja2 template
      template:
        src: server_report.j2
        dest: /tmp/generated_report.csv

    - name: Display the CSV report location
      debug:
        msg: "The CSV report has been generated at /tmp/generated_report.csv"
